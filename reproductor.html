<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reproductor - M√∫sica Pro (Ultra)</title>
  <style>
    :root{--p1:#00c6ff;--p2:#0072ff;--glass:rgba(255,255,255,0.08);--glass-2:rgba(255,255,255,0.12)}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#fff;background:#000;min-height:100vh}
    .wrap{display:flex;gap:30px;padding:28px;align-items:flex-start}
    .left{flex:1;min-width:320px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border:1px solid var(--glass);backdrop-filter:blur(18px);border-radius:18px;padding:22px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .logo{font-weight:800;font-size:20px;background:linear-gradient(90deg,var(--p1),var(--p2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .controls{display:flex;gap:10px}
    .btn{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:10px 14px;border-radius:12px;cursor:pointer}
    .big-art{display:flex;align-items:center;justify-content:center;border-radius:14px;height:420px;background:linear-gradient(135deg,var(--p1),var(--p2));position:relative;overflow:hidden}
    .big-art .label{font-size:120px;opacity:0.95}
    .meta{margin-top:18px;text-align:center}
    .title{font-size:28px;font-weight:800}
    .subtitle{opacity:0.75;margin-top:6px}
    .player-row{display:flex;align-items:center;justify-content:center;gap:18px;margin-top:18px}
    .play-btn{width:86px;height:86px;border-radius:999px;background:linear-gradient(90deg,var(--p1),var(--p2));display:flex;align-items:center;justify-content:center;font-size:34px;border:none;cursor:pointer}
    .small-btn{width:56px;height:56px;border-radius:999px;background:var(--glass);border:none;color:#fff;font-size:22px}
    .progress-wrap{margin-top:16px}
    .progress{height:8px;background:var(--glass);border-radius:999px;overflow:hidden;cursor:pointer}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--p1),var(--p2));width:0%}
    .times{display:flex;justify-content:space-between;font-size:13px;opacity:0.8;margin-top:8px}
    .right{width:420px}
    .playlist{max-height:74vh;overflow:auto;margin-top:12px}
    .pl-item{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;cursor:pointer}
    .pl-item:hover{background:rgba(255,255,255,0.02)}
    .pl-art{width:56px;height:56px;border-radius:8px;background:linear-gradient(90deg,#8a2387,#e94057);display:flex;align-items:center;justify-content:center}
    .pl-meta{flex:1;min-width:0}
    .pl-title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pl-sub{opacity:0.75;font-size:13px}
    .video-container{margin-top:14px;border-radius:12px;overflow:hidden;background:#000}
    video, audio{width:100%;height:100%;display:block}
    .mini{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);padding:8px 14px;border-radius:999px;display:flex;gap:12px;align-items:center;border:1px solid rgba(255,255,255,0.06)}
    /* responsive */
    @media(max-width:1000px){.wrap{flex-direction:column}.right{width:100%}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left card">
      <div class="topbar"><div class="logo">M√∫sica Pro ‚Ä¢ Reproductor Ultra</div><div class="controls"><button class="btn" onclick="goBack()">Biblioteca</button><button class="btn" id="openFolderBtn">Abrir carpeta</button></div></div>

      <div id="art" class="big-art">
        <div class="label">‚ô™</div>
      </div>

      <div class="meta">
        <div id="tTitle" class="title">Selecciona una pista</div>
        <div id="tArtist" class="subtitle">Artista ‚Ä¢ √Ålbum</div>

        <div class="player-row">
          <button class="small-btn" id="prev">‚èÆ</button>
          <button class="play-btn" id="play">‚ñ∂</button>
          <button class="small-btn" id="next">‚è≠</button>
        </div>

        <div class="progress-wrap">
          <div class="progress" id="progress"><i id="progFill"></i></div>
          <div class="times"><span id="curTime">0:00</span><span id="durTime">0:00</span></div>
        </div>

        <div style="display:flex;gap:10px;align-items:center;justify-content:center;margin-top:12px">
          <label style="opacity:0.8">Vol</label>
          <input id="vol" type="range" min="0" max="100" value="80" />
          <button class="btn" id="pipBtn" title="Picture in Picture">PIP</button>
        </div>

      </div>

      <div class="video-container card" id="videoWrap" style="display:none;height:360px;margin-top:16px">
        <!-- se elige audio o video dinamicamente -->
        <video id="videoEl" controls playsinline style="background:#000;display:none"></video>
        <audio id="audioEl" controls style="display:none"></audio>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center"><strong>Cola de reproducci√≥n</strong><span id="plCount">0</span></div>
        <div class="playlist" id="playlist"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center"><strong>Controles avanzados</strong>
        <div><button class="btn" id="shuffleBtn">üîÄ</button><button class="btn" id="repeatBtn">üîÅ</button></div></div>
        <div style="margin-top:10px;opacity:0.8">Soporta audio (mp3,wav,flac,m4a,ogg,aac) y video (mp4,mkv,webm) seg√∫n el navegador. Usa File System Access para leer archivos locales (si tu navegador lo permite).</div>
      </div>
    </div>
  </div>

  <div class="mini" id="mini" style="display:none"><div id="miniText">Nada</div></div>

  <script>
    // Reproductor Ultra - lee biblioteca local y reproduce audio/video
    let db=null; let directoryHandle=null; let playlist=[]; let currentIndex=0; let player=null; // player puede ser audioEl o videoEl

    // Utils
    function fmt(s){ if(!s || isNaN(s)) return '0:00'; const m=Math.floor(s/60); const sec=Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${sec}` }
    function showToast(m){ console.log(m); }

    // open DB
    function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open('MusicProDB',3); r.onupgradeneeded=(e)=>{ const idb=e.target.result; if(!idb.objectStoreNames.contains('music')){ const s=idb.createObjectStore('music',{keyPath:'id',autoIncrement:true}); s.createIndex('title','title',{unique:false}); } if(!idb.objectStoreNames.contains('meta')) idb.createObjectStore('meta',{keyPath:'key'}); }; r.onsuccess=(e)=>{ db=e.target.result; res(db); }; r.onerror=(e)=>rej(e.target.error); }); }

    function metaGet(key){ return new Promise((res,rej)=>{ const tx=db.transaction('meta','readonly'); const s=tx.objectStore('meta'); const rq=s.get(key); rq.onsuccess=()=>res(rq.result?rq.result.value:undefined); rq.onerror=(e)=>rej(e.target.error); }); }
    function metaPut(key,val){ return new Promise((res,rej)=>{ const tx=db.transaction('meta','readwrite'); const s=tx.objectStore('meta'); const rq=s.put({key,value:val}); rq.onsuccess=()=>res(); rq.onerror=(e)=>rej(e.target.error); }); }

    // getAll tracks
    function getAllTracks(){ return new Promise((res,rej)=>{ const tx=db.transaction('music','readonly'); const s=tx.objectStore('music'); const rq=s.getAll(); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=(e)=>rej(e.target.error); }); }

    // read blob for track
    async function fetchBlobForTrack(t){ // t can have storage 'fs' and fileHandleName, or blobKey, or url
      // try FS
      try{
        const saved = await metaGet('directoryHandle'); if(saved) directoryHandle=saved; }catch(e){/*ignored*/}
      if(t.storage==='fs' && directoryHandle){ try{ const fh=await directoryHandle.getFileHandle(t.fileHandleName); const f=await fh.getFile(); return f; }catch(e){console.warn('fs read failed',e); } }
      if(t.blobKey){ const meta = await metaGet(t.blobKey); if(meta) return meta; }
      if(t.url && t.url.startsWith('data:')){ // data url
        const parts=t.url.split(','); const mime=parts[0].match(/:(.*?);/)[1]; const bstr=atob(parts[1]); let n=bstr.length; const u8=new Uint8Array(n); while(n--) u8[n]=bstr.charCodeAt(n); return new Blob([u8],{type:mime}); }
      return null;
    }

    // set player source for a track
    async function setTrackSource(index){ currentIndex=index; const t=playlist[index]; if(!t) return; const blob=await fetchBlobForTrack(t); if(!blob){ showToast('Archivo no disponible localmente'); return; }
      // choose audio or video element depending mime
      const mime=(t.fileType||'').toLowerCase(); const isVideo = mime.startsWith('video') || /\.(mp4|webm|mkv)$/i.test(t.fileName);
      const audioEl=document.getElementById('audioEl'); const videoEl=document.getElementById('videoEl'); const videoWrap=document.getElementById('videoWrap');
      // revoke previous objectURLs
      if(window._lastURL){ URL.revokeObjectURL(window._lastURL); window._lastURL=null; }
      const url = URL.createObjectURL(blob); window._lastURL=url; 
      if(isVideo){ audioEl.style.display='none'; videoEl.style.display='block'; videoWrap.style.display='block'; audioEl.pause(); videoEl.src=url; player=videoEl; videoEl.play().catch(()=>{});
      } else { videoEl.style.display='none'; audioEl.style.display='block'; videoWrap.style.display='none'; videoEl.pause(); audioEl.src=url; player=audioEl; audioEl.play().catch(()=>{}); }

      // update UI
      document.getElementById('tTitle').textContent = t.title || t.fileName || 'Sin t√≠tulo';
      document.getElementById('tArtist').textContent = (t.artist? t.artist + ' ‚Ä¢ ' : '') + (t.fileName||'');
      document.getElementById('plCount').textContent = playlist.length;
      document.getElementById('mini').style.display='flex'; document.getElementById('miniText').textContent = t.title || t.fileName;

      // when metadata loaded update durations
      player.onloadedmetadata = ()=>{ document.getElementById('durTime').textContent = fmt(player.duration); }
      player.ontimeupdate = ()=>{ document.getElementById('curTime').textContent = fmt(player.currentTime); const p = player.duration? (player.currentTime/player.duration*100):0; document.getElementById('progFill').style.width = p + '%'; }
      player.onended = ()=>{ handleNext(); }
      // save state
      localStorage.setItem('currentTrackId', t.id);
    }

    // render playlist
    function renderPlaylist(){ const el=document.getElementById('playlist'); el.innerHTML=''; playlist.forEach((t,i)=>{ const div=document.createElement('div'); div.className='pl-item'; div.innerHTML = `<div class="pl-art">${(t.title||'üéµ').charAt(0).toUpperCase()}</div><div class="pl-meta"><div class="pl-title">${t.title||t.fileName}</div><div class="pl-sub">${t.artist||'Artista'}</div></div>`; div.addEventListener('click', ()=>{ setTrackSource(i); play(); }); el.appendChild(div); }); }

    // controls
    function play(){ if(!player) return; player.play().then(()=>{ document.getElementById('play').textContent='‚è∏'; }).catch(()=>{}); }
    function pause(){ if(!player) return; player.pause(); document.getElementById('play').textContent='‚ñ∂'; }
    function togglePlay(){ if(!player) return player.paused?play():pause(); }
    function handleNext(){ currentIndex = (currentIndex+1) % playlist.length; setTrackSource(currentIndex); }
    function handlePrev(){ if(player && player.currentTime>3){ player.currentTime=0; } else { currentIndex = (currentIndex-1+playlist.length)%playlist.length; setTrackSource(currentIndex); } }

    // load library into playlist
    async function loadLibraryToPlaylist(){ await openDB(); const tracks = await getAllTracks(); playlist = tracks.map(t=>({...t})); renderPlaylist(); if(playlist.length>0) setTrackSource(0); }

    // init
    (function init(){ document.getElementById('play').addEventListener('click', togglePlay); document.getElementById('next').addEventListener('click', handleNext); document.getElementById('prev').addEventListener('click', handlePrev); document.getElementById('progress').addEventListener('click', (e)=>{ if(!player || !player.duration) return; const r=e.currentTarget.getBoundingClientRect(); const pos=(e.clientX-r.left)/r.width; player.currentTime = pos*player.duration; }); document.getElementById('vol').addEventListener('input',(e)=>{ const v=e.target.value/100; const audio=document.getElementById('audioEl'); const video=document.getElementById('videoEl'); audio.volume=v; video.volume=v; localStorage.setItem('volume',v); }); document.getElementById('shuffleBtn').addEventListener('click', ()=>{ playlist = playlist.sort(()=>Math.random()-0.5); renderPlaylist(); }); document.getElementById('repeatBtn').addEventListener('click', ()=>{ const btn=document.getElementById('repeatBtn'); if(!btn.dataset.mode) btn.dataset.mode='none'; const m = btn.dataset.mode; const next = m==='none'?'one':m==='one'?'all':'none'; btn.dataset.mode=next; btn.textContent = next==='none'?'üîÅ': next==='one'?'üîÇ':'üîÅ'; }); document.getElementById('openFolderBtn').addEventListener('click', async ()=>{ if('showDirectoryPicker' in window){ try{ directoryHandle = await window.showDirectoryPicker(); await metaPut('directoryHandle', directoryHandle); // sync
            await syncFromDirectory(); loadLibraryToPlaylist(); showToast('Carpeta sincronizada'); }catch(err){ console.warn(err); showToast('No se pudo abrir carpeta'); } } else showToast('API de carpetas no disponible en este navegador'); }); document.getElementById('pipBtn').addEventListener('click', async ()=>{ try{ if(player && player.requestPictureInPicture){ await player.requestPictureInPicture(); } }catch(e){ showToast('PIP no disponible'); }});
      // set volume from storage
      const v=localStorage.getItem('volume'); if(v) document.getElementById('vol').value = v*100; 
      // open DB and load
      openDB().then(async ()=>{ // restore directory handle if exists
        try{ const saved = await metaGet('directoryHandle'); if(saved) directoryHandle = saved; }catch(e){}
        await loadLibraryToPlaylist(); });
    })();

    // syncFromDirectory: reads directory and updates DB (non recursive simple)
    async function syncFromDirectory(){ if(!directoryHandle) return; await openDB(); // clear and re-add
      const tx = db.transaction(['music'],'readwrite'); const store=tx.objectStore('music'); store.clear(); await new Promise(r=>tx.oncomplete=r);
      for await(const entry of directoryHandle.values()){ try{ if(entry.kind==='file' && /\.(mp3|wav|ogg|m4a|flac|aac|mp4|webm|mkv)$/i.test(entry.name)){ const file = await entry.getFile(); const dur = await (async ()=>{ try{ const tmp = URL.createObjectURL(file); const a = (file.type||'').startsWith('video')?document.createElement('video'):document.createElement('audio'); a.src = tmp; await new Promise(r=>a.onloadedmetadata=r); URL.revokeObjectURL(tmp); return a.duration||0; }catch(e){ return 0; } })(); const parts = entry.name.replace(/\.[^/.]+$/,'').split(' - '); let artist='Artista desconocido', title=entry.name; if(parts.length>=2){ artist = parts[0].trim(); title = parts.slice(1).join(' - ').trim(); } const track={title,artist,fileName:entry.name,fileSize: (await entry.getFile()).size,fileType: (await entry.getFile()).type || '',duration:Math.floor(dur),dateAdded:new Date().toISOString(),storage:'fs',fileHandleName:entry.name}; // save
            await new Promise((res,rej)=>{ const tx2=db.transaction('music','readwrite'); const s=tx2.objectStore('music'); const rq=s.add(track); rq.onsuccess=res; rq.onerror=()=>res(); }); } }catch(e){console.warn(e);} }
    }

    function goBack(){ window.location.href='biblioteca.html'; }

  </script>
</body>
</html>

  </script>
</body>
</html>

