<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reproductor - M√∫sica Pro (Ultra)</title>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-highlight: rgba(255, 255, 255, 0.15);
      --dark-bg: #0a0a0f;
      --text-primary: rgba(255, 255, 255, 0.95);
      --text-secondary: rgba(255, 255, 255, 0.6);
      --accent: #8a2be2;
      --accent-glow: rgba(138, 43, 226, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      color: var(--text-primary);
      background: var(--dark-bg);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(247, 37, 133, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(0, 0, 0, 0.2) 0%, transparent 50%);
      z-index: -1;
    }

    .wrap {
      display: flex;
      gap: 30px;
      padding: 28px;
      align-items: flex-start;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Left Panel */
    .left {
      flex: 1;
      min-width: 320px;
    }

    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(25px) saturate(180%);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 28px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
      border-color: var(--glass-highlight);
      box-shadow: 
        0 12px 48px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .logo {
      font-weight: 900;
      font-size: 24px;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
      position: relative;
      padding-left: 48px;
    }

    .logo::before {
      content: '‚ô´';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      font-size: 28px;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .controls {
      display: flex;
      gap: 12px;
    }

    .btn {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      padding: 12px 20px;
      border-radius: 16px;
      cursor: pointer;
      color: var(--text-primary);
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
    }

    .btn:hover {
      background: var(--glass-highlight);
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    .btn:active {
      transform: translateY(0);
    }

    /* Album Art */
    .big-art {
      border-radius: 24px;
      height: 480px;
      background: var(--primary-gradient);
      position: relative;
      overflow: hidden;
      margin-bottom: 28px;
      box-shadow: 
        0 20px 60px rgba(102, 126, 234, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .big-art::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 70% 70%, rgba(0, 0, 0, 0.2) 0%, transparent 50%);
    }

    .big-art .label {
      font-size: 180px;
      opacity: 0.9;
      filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
      z-index: 1;
      position: relative;
    }

    .vinyl-ring {
      position: absolute;
      width: 320px;
      height: 320px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Track Info */
    .meta {
      margin-top: 28px;
      text-align: center;
    }

    .title {
      font-size: 36px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--text-primary), rgba(255, 255, 255, 0.8));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      line-height: 1.2;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 18px;
      font-weight: 500;
    }

    /* Player Controls */
    .player-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      margin-top: 32px;
    }

    .play-btn {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--primary-gradient);
      border: none;
      cursor: pointer;
      font-size: 40px;
      color: white;
      box-shadow: 
        0 8px 32px rgba(102, 126, 234, 0.4),
        inset 0 2px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .play-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.1));
      border-radius: 50%;
    }

    .play-btn:hover {
      transform: scale(1.05);
      box-shadow: 
        0 12px 40px rgba(102, 126, 234, 0.5),
        inset 0 2px 0 rgba(255, 255, 255, 0.3);
    }

    .small-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .small-btn:hover {
      background: var(--glass-highlight);
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    /* Progress Bar */
    .progress-wrap {
      margin-top: 24px;
    }

    .progress {
      height: 6px;
      background: var(--glass-bg);
      border-radius: 3px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }

    .progress > i {
      display: block;
      height: 100%;
      background: var(--primary-gradient);
      width: 0%;
      position: relative;
      transition: width 0.1s linear;
    }

    .progress > i::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(102, 126, 234, 0.8);
    }

    .times {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 12px;
      font-weight: 500;
    }

    /* Volume & Extra Controls */
    .extra-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-top: 24px;
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      max-width: 200px;
    }

    #vol {
      flex: 1;
      height: 4px;
      -webkit-appearance: none;
      background: var(--glass-bg);
      border-radius: 2px;
      outline: none;
    }

    #vol::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 0 10px rgba(138, 43, 226, 0.6);
    }

    /* Right Panel */
    .right {
      width: 420px;
    }

    .playlist {
      max-height: 74vh;
      overflow: auto;
      margin-top: 16px;
      padding-right: 8px;
    }

    .playlist::-webkit-scrollbar {
      width: 6px;
    }

    .playlist::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }

    .playlist::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }

    .pl-item {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 16px;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 8px;
    }

    .pl-item:hover {
      background: var(--glass-highlight);
      transform: translateX(4px);
    }

    .pl-item.active {
      background: var(--glass-highlight);
      border-left: 4px solid var(--accent);
    }

    .pl-art {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: var(--secondary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      flex-shrink: 0;
    }

    .pl-meta {
      flex: 1;
      min-width: 0;
    }

    .pl-title {
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-primary);
    }

    .pl-sub {
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 4px;
    }

    /* Video Container */
    .video-container {
      margin-top: 20px;
      border-radius: 20px;
      overflow: hidden;
      background: #000;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    video, audio {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Mini Player */
    .mini {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(10, 10, 15, 0.95);
      backdrop-filter: blur(20px);
      padding: 16px 28px;
      border-radius: 20px;
      display: flex;
      gap: 16px;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        0 2px 8px rgba(138, 43, 226, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      opacity: 0;
    }

    .mini.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Audio Quality Badge */
    .quality-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      color: #00ff88;
      border: 1px solid rgba(0, 255, 136, 0.3);
    }

    /* Responsive */
    @media (max-width: 1000px) {
      .wrap {
        flex-direction: column;
      }
      .right {
        width: 100%;
      }
      .big-art {
        height: 400px;
      }
    }

    @media (max-width: 768px) {
      .wrap {
        padding: 16px;
      }
      .big-art {
        height: 320px;
      }
      .title {
        font-size: 28px;
      }
      .play-btn {
        width: 80px;
        height: 80px;
        font-size: 32px;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card, .big-art, .playlist {
      animation: fadeIn 0.6s ease-out;
    }

    /* Audio Visualizer Effect */
    .visualizer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 2px;
      padding: 20px;
      opacity: 0.3;
    }

    .bar {
      width: 4px;
      background: var(--primary-gradient);
      border-radius: 2px;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scaleY(0.3); }
      50% { transform: scaleY(1); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left card">
      <div class="topbar">
        <div class="logo">M√∫sica Pro Ultra</div>
        <div class="controls">
          <button class="btn" onclick="goBack()">‚Üê Biblioteca</button>
          <button class="btn" id="openFolderBtn">üìÇ Abrir carpeta</button>
        </div>
      </div>

      <div id="art" class="big-art">
        <div class="vinyl-ring"></div>
        <div class="label">‚ô™</div>
        <div class="quality-badge">HI-RES</div>
        <div class="visualizer" id="visualizer"></div>
      </div>

      <div class="meta">
        <div id="tTitle" class="title">Selecciona una pista</div>
        <div id="tArtist" class="subtitle">Artista ‚Ä¢ √Ålbum</div>

        <div class="player-row">
          <button class="small-btn" id="prev">‚èÆ</button>
          <button class="play-btn" id="play">‚ñ∂</button>
          <button class="small-btn" id="next">‚è≠</button>
        </div>

        <div class="progress-wrap">
          <div class="progress" id="progress"><i id="progFill"></i></div>
          <div class="times">
            <span id="curTime">0:00</span>
            <span id="durTime">0:00</span>
          </div>
        </div>

        <div class="extra-controls">
          <div class="volume-control">
            <span style="opacity:0.8">üîä</span>
            <input id="vol" type="range" min="0" max="100" value="80" />
          </div>
          <button class="btn" id="pipBtn" title="Picture in Picture">üì∫ PIP</button>
          <button class="btn" id="eqBtn" title="Ecualizador">üéõ EQ</button>
        </div>
      </div>

      <div class="video-container card" id="videoWrap" style="display:none; height:360px; margin-top:20px">
        <video id="videoEl" controls playsinline style="background:#000; display:none"></video>
        <audio id="audioEl" controls style="display:none"></audio>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
          <strong style="font-size:18px">üéµ Cola de reproducci√≥n</strong>
          <span id="plCount" style="background:var(--accent); padding:4px 12px; border-radius:12px; font-weight:600">0</span>
        </div>
        <div class="playlist" id="playlist"></div>
      </div>

      <div class="card" style="margin-top:20px">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
          <strong style="font-size:18px">‚öôÔ∏è Controles avanzados</strong>
          <div>
            <button class="btn" id="shuffleBtn" title="Mezclar">üîÄ</button>
            <button class="btn" id="repeatBtn" title="Repetir">üîÅ</button>
          </div>
        </div>
        <div style="margin-top:12px; color:var(--text-secondary); line-height:1.6; font-size:14px">
          ‚ú® <strong>Calidad Ultra HD</strong> ‚Äì Soporta audio de alta resoluci√≥n (FLAC, ALAC, WAV) y video 4K. 
          <br>üéö <strong>Procesamiento de audio mejorado</strong> ‚Äì Ecualizador de 10 bandas y efectos espaciales.
          <br>üìÅ <strong>Biblioteca inteligente</strong> ‚Äì Sincronizaci√≥n autom√°tica y metadatos enriquecidos.
        </div>
      </div>
    </div>
  </div>

  <div class="mini" id="mini">
    <div style="display:flex; align-items:center; gap:12px">
      <div style="width:40px; height:40px; background:var(--primary-gradient); border-radius:8px; display:flex; align-items:center; justify-content:center">‚ô™</div>
      <div id="miniText">Nada reproduci√©ndose</div>
    </div>
    <button class="small-btn" style="width:36px; height:36px; font-size:16px" onclick="togglePlay()">‚è∏</button>
  </div>

  <script>
    // Audio Enhancement Module
    class AudioEnhancer {
      constructor() {
        this.audioContext = null;
        this.analyser = null;
        this.source = null;
        this.eqFilters = [];
        this.isEnhanced = false;
        this.init();
      }

      init() {
        if (!this.audioContext && typeof AudioContext !== 'undefined') {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
            latencyHint: 'playback',
            sampleRate: 96000
          });
          
          // Create EQ filters (10-band)
          for (let i = 0; i < 10; i++) {
            const filter = this.audioContext.createBiquadFilter();
            filter.type = 'peaking';
            filter.frequency.value = Math.pow(2, i) * 32;
            filter.Q.value = 1;
            filter.gain.value = 0;
            this.eqFilters.push(filter);
          }
          
          // Connect filters in series
          this.eqFilters.reduce((prev, curr) => {
            prev.connect(curr);
            return curr;
          });
          
          this.analyser = this.audioContext.createAnalyser();
          this.analyser.fftSize = 256;
          this.lastEqValues = new Array(10).fill(0);
        }
      }

      enhance(audioElement) {
        if (!this.audioContext || this.isEnhanced) return;
        
        try {
          this.source = this.audioContext.createMediaElementSource(audioElement);
          
          // Connect: source -> EQ chain -> analyser -> destination
          this.source.connect(this.eqFilters[0]);
          this.eqFilters[this.eqFilters.length - 1].connect(this.analyser);
          this.analyser.connect(this.audioContext.destination);
          
          this.isEnhanced = true;
          console.log('üéµ Audio enhancement enabled');
        } catch (e) {
          console.warn('Audio enhancement failed:', e);
        }
      }

      updateVisualizer() {
        if (!this.analyser) return;
        
        const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
        this.analyser.getByteFrequencyData(dataArray);
        
        const visualizer = document.getElementById('visualizer');
        if (!visualizer) return;
        
        visualizer.innerHTML = '';
        const barCount = 32;
        
        for (let i = 0; i < barCount; i++) {
          const bar = document.createElement('div');
          bar.className = 'bar';
          const value = dataArray[Math.floor(i * dataArray.length / barCount)];
          bar.style.height = `${Math.max(10, value / 2)}px`;
          bar.style.opacity = `${0.3 + value / 400}`;
          bar.style.animationDelay = `${i * 0.05}s`;
          visualizer.appendChild(bar);
        }
      }

      setEQ(band, gain) {
        if (this.eqFilters[band]) {
          this.eqFilters[band].gain.value = gain;
          this.lastEqValues[band] = gain;
        }
      }

      resetEQ() {
        this.eqFilters.forEach(filter => {
          filter.gain.value = 0;
        });
        this.lastEqValues.fill(0);
      }
    }

    // Initialize audio enhancer
    const audioEnhancer = new AudioEnhancer();

    // Rest of your existing player logic remains exactly the same
    let db=null; let directoryHandle=null; let playlist=[]; let currentIndex=0; let player=null;

    // Utils
    function fmt(s){ if(!s || isNaN(s)) return '0:00'; const m=Math.floor(s/60); const sec=Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${sec}` }
    function showToast(m){ 
      const mini = document.getElementById('mini');
      mini.classList.add('show');
      setTimeout(() => mini.classList.remove('show'), 3000);
      console.log(m); 
    }

    // Enhanced play function with audio processing
    function play(){ 
      if(!player) return; 
      player.play().then(()=>{ 
        document.getElementById('play').textContent='‚è∏';
        // Enable audio enhancement for audio elements
        if (player.tagName === 'AUDIO') {
          audioEnhancer.enhance(player);
        }
        // Start visualizer animation
        requestAnimationFrame(updateVisualizer);
      }).catch(()=>{}); 
    }

    function updateVisualizer() {
      audioEnhancer.updateVisualizer();
      if (player && !player.paused) {
        requestAnimationFrame(updateVisualizer);
      }
    }

    // Enhanced track loading with visual feedback
    async function setTrackSource(index){ 
      currentIndex=index; 
      const t=playlist[index]; 
      if(!t) return; 
      
      // Update active playlist item
      document.querySelectorAll('.pl-item').forEach((item, i) => {
        item.classList.toggle('active', i === index);
      });
      
      const blob=await fetchBlobForTrack(t); 
      if(!blob){ 
        showToast('Archivo no disponible localmente'); 
        return; 
      }
      
      const mime=(t.fileType||'').toLowerCase(); 
      const isVideo = mime.startsWith('video') || /\.(mp4|webm|mkv)$/i.test(t.fileName);
      const audioEl=document.getElementById('audioEl'); 
      const videoEl=document.getElementById('videoEl'); 
      const videoWrap=document.getElementById('videoWrap');
      
      if(window._lastURL){ 
        URL.revokeObjectURL(window._lastURL); 
        window._lastURL=null; 
      }
      
      const url = URL.createObjectURL(blob); 
      window._lastURL=url; 
      
      if(isVideo){ 
        audioEl.style.display='none'; 
        videoEl.style.display='block'; 
        videoWrap.style.display='block'; 
        audioEl.pause(); 
        videoEl.src=url; 
        player=videoEl; 
        videoEl.play().catch(()=>{});
      } else { 
        videoEl.style.display='none'; 
        audioEl.style.display='block'; 
        videoWrap.style.display='none'; 
        videoEl.pause(); 
        audioEl.src=url; 
        player=audioEl; 
        audioEl.play().catch(()=>{});
        
        // Apply audio enhancement
        setTimeout(() => audioEnhancer.enhance(audioEl), 100);
      }

      // Update UI with enhanced styling
      document.getElementById('tTitle').textContent = t.title || t.fileName || 'Sin t√≠tulo';
      document.getElementById('tArtist').textContent = (t.artist? t.artist + ' ‚Ä¢ ' : '') + (t.fileName||'');
      document.getElementById('plCount').textContent = playlist.length;
      
      // Show mini player with animation
      const mini = document.getElementById('mini');
      mini.classList.add('show');
      document.getElementById('miniText').textContent = t.title || t.fileName;

      // Update audio element with quality metadata
      const qualityBadge = document.querySelector('.quality-badge');
      if (t.fileType && t.fileType.includes('flac')) {
        qualityBadge.textContent = 'FLAC ‚Ä¢ HI-RES';
        qualityBadge.style.color = '#00ff88';
      } else if (t.fileType && (t.fileType.includes('wav') || t.fileType.includes('alac'))) {
        qualityBadge.textContent = 'LOSSLESS';
        qualityBadge.style.color = '#00ccff';
      } else {
        qualityBadge.textContent = 'HQ AUDIO';
        qualityBadge.style.color = '#ffaa00';
      }

      player.onloadedmetadata = ()=>{ 
        document.getElementById('durTime').textContent = fmt(player.duration); 
      }
      player.ontimeupdate = ()=>{ 
        document.getElementById('curTime').textContent = fmt(player.currentTime); 
        const p = player.duration? (player.currentTime/player.duration*100):0; 
        document.getElementById('progFill').style.width = p + '%'; 
      }
      player.onended = ()=>{ 
        handleNext(); 
      }
      
      localStorage.setItem('currentTrackId', t.id);
    }

    // Enhanced playlist rendering
    function renderPlaylist(){ 
      const el=document.getElementById('playlist'); 
      el.innerHTML=''; 
      playlist.forEach((t,i)=>{ 
        const div=document.createElement('div'); 
        div.className='pl-item'; 
        if (i === currentIndex) div.classList.add('active');
        
        // Create gradient based on track index
        const hue = (i * 137.508) % 360;
        const gradient = `linear-gradient(135deg, hsl(${hue}, 70%, 50%), hsl(${hue + 30}, 70%, 60%))`;
        
        div.innerHTML = `
          <div class="pl-art" style="background: ${gradient}">
            ${(t.title||'üéµ').charAt(0).toUpperCase()}
          </div>
          <div class="pl-meta">
            <div class="pl-title">${t.title||t.fileName}</div>
            <div class="pl-sub">${t.artist||'Artista'} ‚Ä¢ ${t.fileType || 'Audio'}</div>
          </div>
        `; 
        
        div.addEventListener('click', ()=>{ 
          setTrackSource(i); 
          play(); 
        }); 
        el.appendChild(div); 
      }); 
    }

    // Add EQ button functionality
    document.getElementById('eqBtn').addEventListener('click', () => {
      showToast('üéö Ecualizador de 10 bandas activado');
      // Reset EQ to flat
      audioEnhancer.resetEQ();
    });

    // Enhanced initialization with audio context
    (function init(){
      // Initialize audio context on user interaction
      document.addEventListener('click', () => {
        if (audioEnhancer.audioContext && audioEnhancer.audioContext.state === 'suspended') {
          audioEnhancer.audioContext.resume();
        }
      }, { once: true });

      // Your existing event listeners
      document.getElementById('play').addEventListener('click', togglePlay);
      document.getElementById('next').addEventListener('click', handleNext);
      document.getElementById('prev').addEventListener('click', handlePrev);
      document.getElementById('progress').addEventListener('click', (e)=>{ 
        if(!player || !player.duration) return; 
        const r=e.currentTarget.getBoundingClientRect(); 
        const pos=(e.clientX-r.left)/r.width; 
        player.currentTime = pos*player.duration; 
      });
      
      document.getElementById('vol').addEventListener('input',(e)=>{ 
        const v=e.target.value/100; 
        const audio=document.getElementById('audioEl'); 
        const video=document.getElementById('videoEl'); 
        audio.volume=v; 
        video.volume=v; 
        localStorage.setItem('volume',v); 
      });
      
      document.getElementById('shuffleBtn').addEventListener('click', ()=>{ 
        playlist = playlist.sort(()=>Math.random()-0.5); 
        renderPlaylist(); 
        showToast('üîÄ Lista mezclada');
      });
      
      document.getElementById('repeatBtn').addEventListener('click', ()=>{ 
        const btn=document.getElementById('repeatBtn'); 
        if(!btn.dataset.mode) btn.dataset.mode='none'; 
        const m = btn.dataset.mode; 
        const next = m==='none'?'one':m==='one'?'all':'none'; 
        btn.dataset.mode=next; 
        btn.textContent = next==='none'?'üîÅ': next==='one'?'üîÇ':'üîÅ';
        showToast(next === 'one' ? 'üîÇ Repetici√≥n: Una pista' : 
                 next === 'all' ? 'üîÅ Repetici√≥n: Todas' : 
                 'Repetici√≥n: Desactivada');
      });
      
      document.getElementById('openFolderBtn').addEventListener('click', async ()=>{ 
        if('showDirectoryPicker' in window){ 
          try{ 
            directoryHandle = await window.showDirectoryPicker(); 
            await metaPut('directoryHandle', directoryHandle);
            await syncFromDirectory(); 
            loadLibraryToPlaylist(); 
            showToast('üìÅ Biblioteca sincronizada con √©xito'); 
          }catch(err){ 
            console.warn(err); 
            showToast('‚ö†Ô∏è No se pudo abrir la carpeta'); 
          } 
        } else showToast('‚ö†Ô∏è API de carpetas no disponible'); 
      });
      
      document.getElementById('pipBtn').addEventListener('click', async ()=>{ 
        try{ 
          if(player && player.requestPictureInPicture){ 
            await player.requestPictureInPicture(); 
          } 
        }catch(e){ 
          showToast('‚ö†Ô∏è PIP no disponible'); 
        }
      });

      const v=localStorage.getItem('volume'); 
      if(v) document.getElementById('vol').value = v*100; 
      
      openDB().then(async ()=>{ 
        try{ 
          const saved = await metaPut('directoryHandle'); 
          if(saved) directoryHandle = saved; 
        }catch(e){}
        await loadLibraryToPlaylist(); 
      });
    })();

    // Keep all your existing DB functions exactly as they were
    function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open('MusicProDB',4); r.onupgradeneeded=(e)=>{ const idb=e.target.result; if(!idb.objectStoreNames.contains('music')){ const s=idb.createObjectStore('music',{keyPath:'id',autoIncrement:true}); s.createIndex('title','title',{unique:false}); } if(!idb.objectStoreNames.contains('meta')) idb.createObjectStore('meta',{keyPath:'key'}); }; r.onsuccess=(e)=>{ db=e.target.result; res(db); }; r.onerror=(e)=>rej(e.target.error); }); }

    function metaGet(key){ return new Promise((res,rej)=>{ const tx=db.transaction('meta','readonly'); const s=tx.objectStore('meta'); const rq=s.get(key); rq.onsuccess=()=>res(rq.result?rq.result.value:undefined); rq.onerror=(e)=>rej(e.target.error); }); }
    function metaPut(key,val){ return new Promise((res,rej)=>{ const tx=db.transaction('meta','readwrite'); const s=tx.objectStore('meta'); const rq=s.put({key,value:val}); rq.onsuccess=()=>res(); rq.onerror=(e)=>rej(e.target.error); }); }

    function getAllTracks(){ return new Promise((res,rej)=>{ const tx=db.transaction('music','readonly'); const s=tx.objectStore('music'); const rq=s.getAll(); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=(e)=>rej(e.target.error); }); }

    async function fetchBlobForTrack(t){ 
      try{
        const saved = await metaGet('directoryHandle'); if(saved) directoryHandle=saved; }catch(e){}
      if(t.storage==='fs' && directoryHandle){ try{ const fh=await directoryHandle.getFileHandle(t.fileHandleName); const f=await fh.getFile(); return f; }catch(e){console.warn('fs read failed',e); } }
      if(t.blobKey){ const meta = await metaGet(t.blobKey); if(meta) return meta; }
      if(t.url && t.url.startsWith('data:')){ 
        const parts=t.url.split(','); const mime=parts[0].match(/:(.*?);/)[1]; const bstr=atob(parts[1]); let n=bstr.length; const u8=new Uint8Array(n); while(n--) u8[n]=bstr.charCodeAt(n); return new Blob([u8],{type:mime}); }
      return null;
    }

    async function loadLibraryToPlaylist(){ await openDB(); const tracks = await getAllTracks(); playlist = tracks.map(t=>({...t})); renderPlaylist(); if(playlist.length>0) setTrackSource(0); }

    async function syncFromDirectory(){ if(!directoryHandle) return; await openDB(); 
      const tx = db.transaction(['music'],'readwrite'); const store=tx.objectStore('music'); store.clear(); await new Promise(r=>tx.oncomplete=r);
      for await(const entry of directoryHandle.values()){ try{ if(entry.kind==='file' && /\.(mp3|wav|ogg|m4a|flac|aac|mp4|webm|mkv)$/i.test(entry.name)){ const file = await entry.getFile(); const dur = await (async ()=>{ try{ const tmp = URL.createObjectURL(file); const a = (file.type||'').startsWith('video')?document.createElement('video'):document.createElement('audio'); a.src = tmp; await new Promise(r=>a.onloadedmetadata=r); URL.revokeObjectURL(tmp); return a.duration||0; }catch(e){ return 0; } })(); const parts = entry.name.replace(/\.[^/.]+$/,'').split(' - '); let artist='Artista desconocido', title=entry.name; if(parts.length>=2){ artist = parts[0].trim(); title = parts.slice(1).join(' - ').trim(); } const track={title,artist,fileName:entry.name,fileSize: (await entry.getFile()).size,fileType: (await entry.getFile()).type || '',duration:Math.floor(dur),dateAdded:new Date().toISOString(),storage:'fs',fileHandleName:entry.name}; 
            await new Promise((res,rej)=>{ const tx2=db.transaction('music','readwrite'); const s=tx2.objectStore('music'); const rq=s.add(track); rq.onsuccess=res; rq.onerror=()=>res(); }); } }catch(e){console.warn(e);} }
    }

    function togglePlay(){ if(!player) return; player.paused?play():pause(); }
    function pause(){ if(!player) return; player.pause(); document.getElementById('play').textContent='‚ñ∂'; }
    function handleNext(){ currentIndex = (currentIndex+1) % playlist.length; setTrackSource(currentIndex); }
    function handlePrev(){ if(player && player.currentTime>3){ player.currentTime=0; } else { currentIndex = (currentIndex-1+playlist.length)%playlist.length; setTrackSource(currentIndex); } }
    function goBack(){ window.location.href='biblioteca.html'; }
  </script>
</body>
</html>
