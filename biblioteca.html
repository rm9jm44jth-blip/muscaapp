<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Biblioteca - M√∫sica Pro</title>

    <!-- Estilos modernizados Glass ultra premium -->
    <style>
        :root {
            --primary-1: #ff375f;
            --primary-2: #ff9f0a;
            --glass-bg: rgba(255, 255, 255, 0.12);
            --glass-bg-hover: rgba(255, 255, 255, 0.18);
            --glass-border: rgba(255, 255, 255, 0.25);
            --card-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
            --gradient: linear-gradient(135deg, var(--primary-1), var(--primary-2));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* NAVBAR */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 22px 40px;
            position: sticky;
            top: 0;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(30px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .logo {
            font-size: 32px;
            font-weight: 900;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 28px;
        }

        .nav-links a {
            padding: 10px 22px;
            border-radius: 100px;
            font-size: 16px;
            text-decoration: none;
            color: #fff;
            opacity: 0.8;
            transition: 0.25s;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background: var(--glass-bg);
            opacity: 1;
        }

        /* HEADER */
        .library-header {
            padding: 60px 40px 40px;
            background: linear-gradient(135deg, rgba(255, 55, 95, 0.15), rgba(255, 159, 10, 0.15));
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .library-header h1 {
            font-size: 54px;
            font-weight: 800;
            margin-bottom: 20px;
        }

        .stats {
            opacity: 0.85;
            display: flex;
            gap: 32px;
            font-size: 19px;
        }

        /* SEARCH */
        .search-container {
            padding: 25px 40px;
            position: sticky;
            top: 80px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1500;
        }

        .search-bar {
            width: 100%;
            max-width: 650px;
            padding: 18px 28px;
            border-radius: 100px;
            font-size: 18px;
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            color: #fff;
            transition: 0.25s;
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--primary-1);
            background: var(--glass-bg-hover);
        }

        /* CONTROLS */
        .controls {
            padding: 30px 40px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-btn {
            padding: 14px 26px;
            border-radius: 100px;
            border: none;
            background: var(--glass-bg);
            color: #fff;
            font-size: 16.5px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.25s;
        }

        .control-btn:hover {
            background: var(--glass-bg-hover);
        }

        .control-btn.primary {
            background: var(--gradient);
            font-weight: 600;
        }

        .control-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 55, 95, 0.35);
        }

        /* GRID */
        .music-grid {
            padding: 40px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 28px;
        }

        .music-item {
            background: var(--glass-bg);
            border-radius: 22px;
            padding: 24px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(25px);
            transition: 0.25s;
            cursor: pointer;
        }

        .music-item:hover {
            transform: translateY(-5px);
            background: var(--glass-bg-hover);
            box-shadow: var(--card-shadow);
        }

        .album-art {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 18px;
            background: var(--gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 56px;
            margin-bottom: 18px;
            position: relative;
        }

        .play-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            font-size: 40px;
            transition: 0.25s;
        }

        .music-item:hover .play-overlay {
            opacity: 1;
        }

        .music-info {
            text-align: center;
        }
        .music-title {
            font-weight: 600;
            font-size: 17px;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-artist {
            opacity: 0.65;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* UPLOAD */
        .upload-area {
            margin: 40px;
            padding: 60px;
            border: 3px dashed var(--glass-border);
            border-radius: 30px;
            text-align: center;
            transition: 0.25s;
            cursor: pointer;
        }

        .upload-area:hover,
        .upload-area.dragover {
            background: rgba(255, 55, 95, 0.08);
            border-color: var(--primary-1);
            transform: scale(1.01);
        }

        .upload-icon {
            font-size: 72px;
            opacity: 0.5;
            margin-bottom: 25px;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(30px);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(40px);
            border-radius: 30px;
            padding: 50px;
            max-width: 900px;
            width: 100%;
            border: 1px solid var(--glass-border);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 25px;
            right: 25px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: var(--glass-bg);
            color: #fff;
            font-size: 26px;
            cursor: pointer;
            transition: 0.25s;
        }

        .modal-close:hover {
            background: var(--glass-bg-hover);
            transform: rotate(90deg);
        }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 18px 28px;
            backdrop-filter: blur(25px);
            border-radius: 14px;
            font-weight: 600;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(40px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

    </style>
</head>
<body>
    <!-- NAV -->
    <nav>
        <div class="logo">M√∫sica Pro</div>
        <div class="nav-links">
            <a href="index.html">Inicio</a>
            <a class="active" href="biblioteca.html">Biblioteca</a>
            <a href="reproductor.html">Reproductor</a>
            <a href="playlists.html">Playlists</a>
        </div>
    </nav>

    <!-- HEADER -->
    <header class="library-header">
        <h1>Tu Biblioteca</h1>
        <div class="stats">
            <span id="totalSongs">0 canciones</span>
            <span id="totalArtists">0 artistas</span>
            <span id="totalDuration">0 min</span>
        </div>
    </header>

    <!-- SEARCH -->
    <div class="search-container">
        <input id="searchInput" class="search-bar" type="text" placeholder="Buscar canciones, artistas, √°lbumes..." />
    </div>

    <!-- CONTROLES -->
    <div class="controls">
        <button class="control-btn primary" id="addMusicBtn">‚ûï Agregar M√∫sica</button>
        <button class="control-btn" id="sortBtn">‚áÖ Ordenar</button>
        <button class="control-btn" id="filterBtn">‚öôÔ∏è Filtros</button>
        <button class="control-btn" id="refreshBtn">üîÑ Actualizar</button>
    </div>

    <input type="file" id="fileInput" style="display:none;" accept="audio/*" multiple />

    <!-- UPLOAD -->
    <div id="uploadArea" class="upload-area">
        <div class="upload-icon">üéµ</div>
        <div class="upload-text">Arrastra tu m√∫sica aqu√≠</div>
        <div class="upload-subtext">o haz clic para seleccionar archivos</div>
    </div>

    <!-- GRID -->
    <div id="musicGrid" class="music-grid"></div>

    <!-- MODAL -->
    <div id="musicModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>

    <!-- SCRIPTS (MEJORADOS) -->
    <script>
        /*
         * M√∫sica Pro - Biblioteca (JS modernizado)
         * - Guarda archivos en carpeta local mediante File System Access API si est√° disponible
         * - Fallback a IndexedDB si no hay soporte
         * - Usa object URLs para reproducir localmente sin re-cargar desde la red
         * - Mejora handling de drag & drop y evita errores al inicializar
         */

        let db = null;
        let currentTracks = [];
        let directoryHandle = null; // FileSystemDirectoryHandle si el navegador lo permite

        // ---------- IndexedDB ----------
        function openDB() {
            return new Promise((resolve, reject) => {
                try {
                    const req = indexedDB.open('MusicProDB', 2);

                    req.onupgradeneeded = (e) => {
                        const idb = e.target.result;
                        if (!idb.objectStoreNames.contains('music')) {
                            const store = idb.createObjectStore('music', { keyPath: 'id', autoIncrement: true });
                            store.createIndex('title', 'title', { unique: false });
                            store.createIndex('artist', 'artist', { unique: false });
                        }
                        if (!idb.objectStoreNames.contains('meta')) {
                            idb.createObjectStore('meta', { keyPath: 'key' });
                        }
                    };

                    req.onsuccess = (e) => {
                        db = e.target.result;
                        resolve(db);
                    };

                    req.onerror = (e) => reject(e.target.error);
                } catch (err) {
                    reject(err);
                }
            });
        }

        async function saveMeta(key, value) {
            if (!db) await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['meta'], 'readwrite');
                const store = tx.objectStore('meta');
                const req = store.put({ key, value });
                req.onsuccess = () => resolve();
                req.onerror = (e) => reject(e.target.error);
            });
        }

        async function getMeta(key) {
            if (!db) await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['meta'], 'readonly');
                const store = tx.objectStore('meta');
                const req = store.get(key);
                req.onsuccess = () => resolve(req.result ? req.result.value : undefined);
                req.onerror = (e) => reject(e.target.error);
            });
        }

        // ---------- Directory (File System Access API) ----------
        async function requestDirectoryAccess() {
            if (!('showDirectoryPicker' in window)) return false;
            try {
                // Si ya tenemos handle en memoria, pedir permiso
                const saved = await getMeta('directoryHandle');
                if (saved) {
                    try {
                        // structured clone preserves handles in compatible browsers
                        directoryHandle = saved;
                        // pedir permiso de lectura/escritura
                        const perm = await directoryHandle.requestPermission({ mode: 'readwrite' });
                        if (perm === 'granted') return true;
                    } catch (err) {
                        // contin√∫a para pedir nuevo handle
                        directoryHandle = null;
                    }
                }

                directoryHandle = await window.showDirectoryPicker({ id: 'musicpro-library' });
                // pedir permiso
                const permission = await directoryHandle.requestPermission({ mode: 'readwrite' });
                if (permission === 'granted') {
                    // guardar handle en indexedDB para uso futuro (si el navegador lo permite)
                    try { await saveMeta('directoryHandle', directoryHandle); } catch (e) { /* no cr√≠tico */ }
                    return true;
                }
                return false;
            } catch (err) {
                console.warn('No se pudo acceder al directorio:', err);
                return false;
            }
        }

        // Guarda archivo f√≠sico en la carpeta seleccionada y devuelve un File usable para reproducir
        async function saveFileToDirectory(file) {
            if (!directoryHandle) throw new Error('No directory handle');
            const name = file.name;
            const fh = await directoryHandle.getFileHandle(name, { create: true });
            const writable = await fh.createWritable();
            await writable.write(file);
            await writable.close();
            const savedFile = await fh.getFile();
            return savedFile;
        }

        // ---------- DB: guardar pista (metadatos + ubicaci√≥n) ----------
        function saveTrackToDB(track) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['music'], 'readwrite');
                const store = tx.objectStore('music');
                const req = store.add(track);
                req.onsuccess = () => resolve(req.result);
                req.onerror = (e) => reject(e.target.error || new Error('Error al guardar pista'));
            });
        }

        function getAllTracks() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['music'], 'readonly');
                const store = tx.objectStore('music');
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = (e) => reject(e.target.error);
            });
        }

        async function deleteTrackById(id) {
            const tx = db.transaction(['music'], 'readwrite');
            const store = tx.objectStore('music');
            store.delete(Number(id));
            return new Promise((res) => { tx.oncomplete = () => res(); });
        }

        // ---------- UI Renders ----------
        function renderMusicGrid(tracks) {
            currentTracks = tracks;
            const grid = document.getElementById('musicGrid');

            if (!tracks || tracks.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column:1/-1;text-align:center;padding:80px 20px;opacity:0.9;">
                        <div style="font-size:72px;opacity:0.25;margin-bottom:20px;">üéµ</div>
                        <div style="font-size:22px;margin-bottom:10px;">Tu biblioteca est√° vac√≠a</div>
                        <div style="opacity:0.7;margin-bottom:20px;max-width:560px;margin-left:auto;margin-right:auto;">Arrastra archivos o haz clic en "Agregar M√∫sica" para empezar.</div>
                        <button class="control-btn primary" onclick="document.getElementById('fileInput').click()">‚ûï Agregar M√∫sica</button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = '';

            for (const track of tracks) {
                const item = document.createElement('div');
                item.className = 'music-item';
                item.dataset.id = track.id;

                const firstChar = track.title ? track.title.charAt(0).toUpperCase() : '‚ô´';

                item.innerHTML = `
                    <div class="album-art">
                        <div>${firstChar}</div>
                        <div class="play-overlay">‚ñ∂</div>
                    </div>
                    <div class="music-info">
                        <div class="music-title">${escapeHtml(track.title || 'Sin t√≠tulo')}</div>
                        <div class="music-artist">${escapeHtml(track.artist || 'Artista desconocido')}</div>
                    </div>
                `;

                // click para abrir modal
                item.addEventListener('click', (e) => {
                    // si hicieron click en overlay reproducir
                    if (e.target.closest('.play-overlay')) {
                        playTrack(track);
                        return;
                    }
                    showTrackDetails(track);
                });

                // doble click para reproducir
                item.addEventListener('dblclick', () => playTrack(track));

                grid.appendChild(item);
            }
        }

        function updateStats(tracks) {
            document.getElementById('totalSongs').textContent = `${tracks.length} canciones`;
            const artists = new Set(tracks.map(t => t.artist).filter(Boolean));
            document.getElementById('totalArtists').textContent = `${artists.size} artistas`;
            const totalDuration = tracks.reduce((s, t) => s + (t.duration || 0), 0);
            document.getElementById('totalDuration').textContent = `${Math.floor(totalDuration/60)} min`;
        }

        // Sanitizar texto para insertar en HTML
        function escapeHtml(text) {
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // ---------- Modal ----------
        function showTrackDetails(track) {
            const modal = document.getElementById('musicModal');
            const content = document.getElementById('modalContent');
            const firstChar = track.title ? track.title.charAt(0).toUpperCase() : '‚ô´';
            const fileSizeMB = (track.fileSize / 1024 / 1024).toFixed(2);
            const duration = track.duration ? formatTime(track.duration) : 'Desconocida';
            const dateAdded = track.dateAdded ? new Date(track.dateAdded).toLocaleString() : 'Desconocida';
            const format = (track.fileType && track.fileType.split('/')[1]) ? track.fileType.split('/')[1].toUpperCase() : 'DESCONOCIDO';

            content.innerHTML = `
                <div class="modal-track-info">
                    <div class="modal-album-art">${firstChar}</div>
                    <div class="modal-track-details">
                        <div class="modal-track-title">${escapeHtml(track.title || 'Sin t√≠tulo')}</div>
                        <div class="modal-track-artist">${escapeHtml(track.artist || 'Artista desconocido')}</div>
                        <div class="modal-track-album" style="opacity:0.8;margin-bottom:8px;">${escapeHtml(track.fileName || '')}</div>
                        <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap;">
                            <button class="modal-action-btn play" onclick='playTrackById(${track.id})'>‚ñ∂ Reproducir</button>
                            <button class="modal-action-btn secondary" onclick='exportTrack(${track.id})'>‚¨áÔ∏è Guardar copia</button>
                            <button class="modal-action-btn secondary" onclick='removeTrack(${track.id})'>üóëÔ∏è Eliminar</button>
                        </div>

                    </div>
                </div>
                <div class="modal-stats">
                    <div class="stat-item"><div class="stat-label">Duraci√≥n</div><div class="stat-value">${duration}</div></div>
                    <div class="stat-item"><div class="stat-label">Tama√±o</div><div class="stat-value">${fileSizeMB} MB</div></div>
                    <div class="stat-item"><div class="stat-label">Formato</div><div class="stat-value">${format}</div></div>
                    <div class="stat-item"><div class="stat-label">Agregado</div><div class="stat-value">${escapeHtml(dateAdded)}</div></div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        function closeModal() { document.getElementById('musicModal').style.display = 'none'; }

        // ---------- Reproducci√≥n ----------
        // Reproduce track usando su id (busca en indexedDB)
        async function playTrackById(id) {
            const tracks = await getAllTracks();
            const t = tracks.find(x => Number(x.id) === Number(id));
            if (t) playTrack(t);
        }

        async function playTrack(track) {
            try {
                // Intentar obtener File/Blob para reproducir
                let fileBlob = null;
                if (track.storage === 'fs' && track.fileName && directoryHandle) {
                    try {
                        const fh = await directoryHandle.getFileHandle(track.fileName);
                        const f = await fh.getFile();
                        fileBlob = f;
                    } catch (err) {
                        console.warn('No se pudo leer archivo desde FS, fallback a blob guardado');
                    }
                }

                if (!fileBlob && track.blobKey) {
                    // Hemos guardado blob en DB (fallback)
                    fileBlob = await readBlobFromIDB(track.blobKey);
                }

                if (!fileBlob && track.url) {
                    // quiz√° se guard√≥ URL (data URL)
                    fileBlob = dataURLtoBlob(track.url);
                }

                if (!fileBlob) {
                    showToast('No se pudo acceder al archivo para reproducir');
                    return;
                }

                // crear URL para audio
                const url = URL.createObjectURL(fileBlob);

                // guardar informacion en localStorage para reproductor (si hay)
                localStorage.setItem('currentTrackBlobUrl', url);
                localStorage.setItem('currentTrack', JSON.stringify(track));

                // abrir reproductor en nueva pesta√±a o en pagina reproductor
                window.location.href = 'reproductor.html';
            } catch (err) {
                console.error(err);
                showToast('Error al intentar reproducir');
            }
        }

        // ---------- Blob IDB storage (fallback) ----------
        function saveBlobInIDB(blob) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['meta'], 'readwrite');
                const store = tx.objectStore('meta');
                const key = `blob-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
                const req = store.put({ key, value: blob });
                req.onsuccess = () => resolve(key);
                req.onerror = (e) => reject(e.target.error);
            });
        }

        function readBlobFromIDB(key) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['meta'], 'readonly');
                const store = tx.objectStore('meta');
                const req = store.get(key);
                req.onsuccess = () => resolve(req.result ? req.result.value : null);
                req.onerror = (e) => reject(e.target.error);
            });
        }

        // ---------- Manejo de archivos (drag/drop + input) ----------
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', async (e) => {
            await handleFiles(e.target.files);
            fileInput.value = '';
        });

        document.getElementById('uploadArea').addEventListener('click', () => fileInput.click());

        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; document.getElementById('uploadArea').classList.add('dragover'); }
        function handleDragLeave(e) { e.preventDefault(); document.getElementById('uploadArea').classList.remove('dragover'); }
        async function handleDrop(e) { e.preventDefault(); document.getElementById('uploadArea').classList.remove('dragover'); await handleFiles(e.dataTransfer.files); }
        document.getElementById('uploadArea').addEventListener('dragover', handleDragOver);
        document.getElementById('uploadArea').addEventListener('dragleave', handleDragLeave);
        document.getElementById('uploadArea').addEventListener('drop', handleDrop);

        async function handleFiles(fileList) {
            if (!fileList || fileList.length === 0) return;
            const files = Array.from(fileList).filter(f => f.type && f.type.startsWith('audio/'));
            if (files.length === 0) { showToast('No se encontraron archivos de audio'); return; }

            // intentar pedir acceso a carpeta (una sola vez)
            let haveDir = !!directoryHandle;
            if (!haveDir) {
                haveDir = await requestDirectoryAccess();
            }

            let processed = 0;

            for (const file of files) {
                try {
                    // extraer metadatos simples
                    const fileNameNoExt = file.name.replace(/\.[^/.]+$/, '');
                    const parts = fileNameNoExt.split(' - ');
                    let artist = 'Artista desconocido';
                    let title = fileNameNoExt;
                    if (parts.length >= 2) { artist = parts[0].trim(); title = parts.slice(1).join(' - ').trim(); }

                    // obtener duracion de manera as√≠ncrona
                    const duration = await getAudioDuration(file);

                    // si tenemos directoryHandle intentar guardar fichero fisico
                    let storage = 'idb';
                    let blobKey = null;
                    let savedFilename = null;

                    if (haveDir) {
                        try {
                            const savedFile = await saveFileToDirectory(file);
                            storage = 'fs';
                            savedFilename = savedFile.name;
                        } catch (err) {
                            console.warn('No se pudo grabar en la carpeta, se guarda en IndexedDB', err);
                            storage = 'idb';
                        }
                    }

                    // si no guardamos en FS, guardamos blob en IDB (meta store)
                    if (storage === 'idb') {
                        blobKey = await saveBlobInIDB(file);
                    }

                    const track = {
                        title: title,
                        artist: artist,
                        fileName: file.name,
                        fileSize: file.size,
                        fileType: file.type,
                        duration: Math.floor(duration) || 0,
                        dateAdded: new Date().toISOString(),
                        storage: storage, // 'fs' o 'idb'
                        blobKey: blobKey || null,
                        fileNameOnDisk: savedFilename || null
                    };

                    await saveTrackToDB(track);
                    processed++;
                    showToast(`Procesado ${processed}/${files.length}`);
                } catch (err) {
                    console.error('Error procesando archivo', err);
                    showToast(`Error procesando ${file.name}`);
                }
            }

            // recargar biblioteca
            await loadMusic();
            showToast(`${processed} canci√≥n(es) agregadas`);
        }

        // Obtener duraci√≥n de un archivo audio como Blob
        function getAudioDuration(file) {
            return new Promise((resolve) => {
                const url = URL.createObjectURL(file);
                const audio = new Audio();
                audio.src = url;
                audio.addEventListener('loadedmetadata', () => {
                    const d = audio.duration || 0;
                    URL.revokeObjectURL(url);
                    resolve(d);
                });
                audio.addEventListener('error', () => { URL.revokeObjectURL(url); resolve(0); });
            });
        }

        // util: dataURL -> blob
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) u8arr[n] = bstr.charCodeAt(n);
            return new Blob([u8arr], { type: mime });
        }

        // ---------- Exportar pista (guardar copia) ----------
        async function exportTrack(id) {
            const tracks = await getAllTracks();
            const t = tracks.find(x => Number(x.id) === Number(id));
            if (!t) return showToast('No encontrado');

            // intentar obtener blob
            let blob = null;
            if (t.storage === 'fs' && directoryHandle) {
                try {
                    const fh = await directoryHandle.getFileHandle(t.fileNameOnDisk || t.fileName);
                    blob = await fh.getFile();
                } catch (err) { console.warn(err); }
            }
            if (!blob && t.blobKey) blob = await readBlobFromIDB(t.blobKey);
            if (!blob) return showToast('No se pudo obtener el archivo para exportar');

            // usar File System Access API para permitir al usuario guardar copia (showSaveFilePicker)
            try {
                if ('showSaveFilePicker' in window) {
                    const opts = { suggestedName: t.fileName, types: [{ description: 'Audio', accept: { [t.fileType]: ['.mp3', '.wav', '.ogg', '.m4a'] } }] };
                    const handle = await window.showSaveFilePicker(opts);
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    showToast('Copia guardada correctamente');
                    return;
                }
            } catch (err) {
                console.warn(err);
            }

            // fallback: usar descarga autom√°tica
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = t.fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            showToast('Descarga iniciada');
        }

        // ---------- Eliminar pista ----------
        async function removeTrack(id) {
            await deleteTrackById(id);
            await loadMusic();
            closeModal();
            showToast('Eliminado');
        }

        // ---------- Cargar biblioteca ----------
        async function loadMusic() {
            try {
                if (!db) await openDB();
                // recuperar directory handle si lo hay
                const savedHandle = await getMeta('directoryHandle');
                if (savedHandle && !directoryHandle) {
                    try { directoryHandle = savedHandle; } catch (err) { directoryHandle = null; }
                }

                const tracks = await getAllTracks();
                renderMusicGrid(tracks);
                updateStats(tracks);
            } catch (err) {
                console.error(err);
                showToast('Error al cargar la biblioteca');
            }
        }

        // ---------- Utilidades ----------
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60);
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }

        function showToast(msg, time = 3000) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            clearTimeout(t._timer);
            t._timer = setTimeout(() => { t.style.display = 'none'; }, time);
        }

        // ---------- Acciones UI ----------
        document.getElementById('addMusicBtn').addEventListener('click', async () => {
            // preguntar si queremos dar acceso a carpeta para guardar autom√°ticamente
            if ('showDirectoryPicker' in window) {
                const r = confirm('¬øDeseas seleccionar una carpeta en tu equipo para que la app guarde all√≠ tus archivos (recomendado)?');
                if (r) {
                    const ok = await requestDirectoryAccess();
                    if (!ok) showToast('No se concedieron permisos de carpeta. Se usar√° almacenamiento interno.');
                }
            }
            document.getElementById('fileInput').click();
        });

        document.getElementById('refreshBtn').addEventListener('click', loadMusic);

        // Inicializar todo al cargar
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDB();
                await loadMusic();
            } catch (err) {
                console.error('Error inicializando:', err);
                showToast('Error en inicializaci√≥n. Revisa la consola.');
            }
        });
    </script>
</body>
</html>
